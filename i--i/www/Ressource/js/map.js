// Generated by CoffeeScript 1.8.0
(function() {
  var eventIcon, eventLayer, filterEvents, getIcon, map, showMap, tiles, userIcon;

  tiles = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' + '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' + 'Imagery © <a href="http://mapbox.com">Mapbox</a>',
    id: 'examples.map-i875mjb7'
  });

  map = L.map('map', {
    center: [46.818188, 8.227512],
    zoom: 8,
    layers: [tiles]
  });

  eventLayer = L.markerClusterGroup({
    spiderfyDistanceMultiplier: 2
  }).addTo(map);

  userIcon = L.icon({
    iconUrl: fw.getRessource("userIMG"),
    iconSize: [30, 30],
    iconAnchor: [15, 15],
    popupAnchor: [0, 0]
  });

  eventIcon = L.Icon.extend({
    options: {
      iconSize: [46, 46],
      iconAnchor: [23, 23],
      popupAnchor: [0, 0]
    }
  });

  getIcon = function(iconName) {
    return new eventIcon({
      iconUrl: fw.getRessource(iconName + "IMG")
    });
  };

  showMap = function(userPos) {
    var userMarker;
    map.setView(userPos, 10);
    return userMarker = L.marker(userPos, {
      icon: userIcon
    }).addTo(map).bindPopup("Vous êtes par là... à peu près").openPopup();
  };

  navigator.geolocation.getCurrentPosition(function(pos) {
    return showMap(new L.LatLng(pos.coords.latitude, pos.coords.longitude));
  });

  filterEvents = function(events) {
    return fw.requestServer({
      app: "map",
      controller: "filterEvents",
      callback: function(results) {
        var result, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = results.length; _i < _len; _i++) {
          result = results[_i];
          _results.push((function(result) {
            var i, lat, lng, pictureName, range, text, _fn, _j, _len1, _ref;
            lng = result.location.coordinates[0];
            lat = result.location.coordinates[1];
            pictureName = result.category + "_" + result.type;
            text = "";
            _ref = result.timetables;
            _fn = function(range, i) {
              var date, j, _k, _len2, _ref1, _results1;
              _ref1 = range.dates;
              _results1 = [];
              for (j = _k = 0, _len2 = _ref1.length; _k < _len2; j = ++_k) {
                date = _ref1[j];
                if (j > 0) {
                  text += ", ";
                }
                _results1.push(text += date);
              }
              return _results1;
            };
            for (i = _j = 0, _len1 = _ref.length; _j < _len1; i = ++_j) {
              range = _ref[i];
              _fn(range, i);
            }
            text += "<br />" + "<a ui-sref='eventDetail' data-ng-click='test()'>" + result.titles[0].text + "</a>";
            return L.marker([lat, lng], {
              icon: getIcon(pictureName)
            }).bindPopup(text).addTo(eventLayer);
          })(result));
        }
        return _results;
      }
    });
  };

  fw.pubsub.subscribe("filterEvents", filterEvents, true);

  fw.pubsub.publish("filterEvents", {});

}).call(this);
